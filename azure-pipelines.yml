trigger:
  branches:
    include:
    - '*'
  tags:
    include:
    - '*'

jobs:
  - job: Test
    condition: |
      and(
        not(startsWith(variables['Build.SourceBranch'], 'refs/tags/')),
        or(
          eq(variables['Build.Reason'], 'PullRequest'),
          eq(variables['Build.SourceBranch'], 'refs/heads/master')
        )
      )
    pool:
      vmImage: 'VS2017-Win2016'
    steps:
      - template: windows-dependencies.yml
        parameters:
          rustup_toolchain: '1.41.0-x86_64-pc-windows-msvc'
      - checkout: self
        submodules: recursive
      - script: cargo test
        displayName: Run unit tests
